# ============================================================
# Pyrl Web Server - Real HTTP Server with Authentication
# Works with: python scripts/run_web_app.py --file examples/web_server_auth_real.pyrl
# ============================================================

# Server configuration
$PORT = env_get("PYRL_PORT", "8080")
$HOST = env_get("PYRL_HOST", "0.0.0.0")
$SECRET_KEY = env_get("PYRL_SECRET", "pyrl_secret_key_2024")

# Users database (in-memory)
%users = {
    "admin": {password: "admin123", role: "administrator", name: "Administrator"},
    "user": {password: "user123", role: "user", name: "Regular User"},
    "guest": {password: "guest123", role: "guest", name: "Guest User"}
}

# Sessions storage
%sessions = {}

# ============================================================
# HTML Templates (Frontend)
# ============================================================

# Login page template
$login_page = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyrl Admin - Login</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo h1 {
            color: #1a1a2e;
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        .logo span {
            color: #e94560;
        }
        .logo p {
            color: #666;
            font-size: 0.9em;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #e94560;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }
        .error-message {
            background: #ffe6e6;
            color: #d63031;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #d63031;
            display: none;
        }
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #e94560 0%, #c23a51 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }
        .footer {
            text-align: center;
            margin-top: 25px;
            color: #666;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <h1>Pyrl<span>Admin</span></h1>
            <p>Web Application Dashboard</p>
        </div>
        
        <div class="error-message" id="errorBox">
            <strong>Error!</strong> Invalid username or password.
        </div>
        
        <form id="loginForm" method="POST" action="/login">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" placeholder="Enter your username" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" name="password" placeholder="Enter your password" required>
            </div>
            <button type="submit" class="btn">Sign In</button>
        </form>
        
        <div class="footer">
            <p>Powered by Pyrl Language</p>
            <p>Demo: admin / admin123</p>
        </div>
    </div>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('error') === '1') {
            document.getElementById('errorBox').style.display = 'block';
        }
    </script>
</body>
</html>
"""

# Dashboard template
$dashboard_page = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pyrl Admin - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .header h1 { font-size: 1.8em; }
        .header span { color: #e94560; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar {
            width: 45px; height: 45px;
            background: #e94560;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2em;
        }
        .user-details { text-align: right; }
        .user-name { font-weight: 600; }
        .user-role { font-size: 0.85em; opacity: 0.8; }
        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        .btn-logout:hover { background: rgba(255, 255, 255, 0.3); }
        .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
        .welcome-banner {
            background: linear-gradient(135deg, #e94560 0%, #c23a51 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3);
        }
        .welcome-banner h2 { font-size: 2em; margin-bottom: 10px; }
        .welcome-banner p { opacity: 0.9; font-size: 1.1em; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .stat-icon {
            width: 50px; height: 50px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; margin-bottom: 15px;
        }
        .stat-icon.users { background: #e3f2fd; color: #2196f3; }
        .stat-icon.posts { background: #e8f5e9; color: #4caf50; }
        .stat-icon.views { background: #fff3e0; color: #ff9800; }
        .stat-icon.storage { background: #fce4ec; color: #e91e63; }
        .stat-value { font-size: 2.2em; font-weight: 700; color: #1a1a2e; }
        .stat-label { color: #666; font-size: 0.95em; margin-top: 5px; }
    </style>
</head>
<body>
    <header class="header">
        <h1>Pyrl<span>Admin</span></h1>
        <div class="user-info">
            <div class="user-details">
                <div class="user-name">{{USERNAME}}</div>
                <div class="user-role">{{ROLE}}</div>
            </div>
            <div class="user-avatar">{{AVATAR}}</div>
            <form action="/logout" method="POST">
                <button type="submit" class="btn-logout">Logout</button>
            </form>
        </div>
    </header>
    
    <div class="container">
        <div class="welcome-banner">
            <h2>Welcome, {{USERNAME}}!</h2>
            <p>You are logged in as <strong>{{ROLE}}</strong>.</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon users">Users</div>
                <div class="stat-value">1,234</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon posts">Posts</div>
                <div class="stat-value">567</div>
                <div class="stat-label">Posts Created</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon views">Views</div>
                <div class="stat-value">89.5K</div>
                <div class="stat-label">Page Views</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon storage">Disk</div>
                <div class="stat-value">2.4 GB</div>
                <div class="stat-label">Storage Used</div>
            </div>
        </div>
    </div>
</body>
</html>
"""

# Error page template
$error_page = """
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Error - Pyrl Admin</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .error-container { text-align: center; }
        .error-code {
            font-size: 8em;
            font-weight: 700;
            color: #e94560;
            margin-bottom: 20px;
        }
        .error-message { font-size: 1.5em; margin-bottom: 30px; opacity: 0.9; }
        .btn-home {
            background: #e94560;
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="error-container">
        <div class="error-code">{{CODE}}</div>
        <div class="error-message">{{MESSAGE}}</div>
        <a href="/" class="btn-home">Go to Login</a>
    </div>
</body>
</html>
"""

# ============================================================
# Authentication Functions
# ============================================================

# Generate session token
def generate_token($username):
    $timestamp = str(time())
    $data = $username + ":" + $timestamp + ":" + $SECRET_KEY
    return str(hash($data))

# Verify user credentials
def verify_user($username, $password):
    $user = get(%users, $username, None)
    if $user != None:
        if $user["password"] == $password:
            return {success: True, user: $user}
    return {success: False, error: "Invalid username or password"}

# Create session
def create_session($username):
    $token = generate_token($username)
    %sessions[$token] = {
        username: $username,
        created: time(),
        expires: time() + 3600
    }
    return $token

# Validate session
def validate_session($token):
    $session = get(%sessions, $token, None)
    if $session != None:
        if $session["expires"] > time():
            return {valid: True, username: $session["username"]}
    return {valid: False}

# ============================================================
# HTTP Request Handler (Main entry point for server)
# ============================================================

def handle_request($method, $path, %headers, $body):
    # GET / - Login page
    if $path == "/" and $method == "GET":
        print("[GET /] Serving login page")
        return html_response($login_page)
    
    # POST /login - Process login
    if $path == "/login" and $method == "POST":
        print("[POST /login] Processing login attempt")
        
        # Parse form data
        %form = parse_form($body)
        $username = get(%form, "username", "")
        $password = get(%form, "password", "")
        
        print("  Username: " + $username)
        
        # Verify credentials
        $result = verify_user($username, $password)
        
        if $result["success"]:
            print("  Result: SUCCESS")
            $token = create_session($username)
            return {
                status: 302,
                headers: {
                    "Location": "/dashboard",
                    "Set-Cookie": "session=" + $token + "; HttpOnly; Path=/"
                },
                body: ""
            }
        else:
            print("  Result: FAILED")
            return {
                status: 302,
                headers: {"Location": "/?error=1"},
                body: ""
            }
    
    # GET /dashboard - Admin dashboard
    if $path == "/dashboard" and $method == "GET":
        print("[GET /dashboard] Serving dashboard")
        
        # Check for session cookie
        $cookie = get(%headers, "Cookie", "")
        %cookies = parse_cookies($cookie)
        $token = get(%cookies, "session", "")
        
        # Validate session
        $session_result = validate_session($token)
        
        if $session_result["valid"]:
            $username = $session_result["username"]
            $user = %users[$username]
            
            print("  User: " + $username)
            print("  Role: " + $user["role"])
            
            # Build dashboard HTML
            $html = $dashboard_page
            $html = replace($html, "{{USERNAME}}", $user["name"])
            $html = replace($html, "{{ROLE}}", $user["role"])
            $html = replace($html, "{{AVATAR}}", upper($username[0]))
            
            return html_response($html)
        
        # Not authenticated - redirect to login
        print("  Not authenticated - redirecting to login")
        return redirect("/")
    
    # POST /logout - Logout user
    if $path == "/logout" and $method == "POST":
        print("[POST /logout] Logging out user")
        return {
            status: 302,
            headers: {
                "Location": "/",
                "Set-Cookie": "session=; HttpOnly; Path=/; Max-Age=0"
            },
            body: ""
        }
    
    # GET /api/status - API endpoint
    if $path == "/api/status" and $method == "GET":
        print("[GET /api/status] API status check")
        %response = {
            status: "ok",
            version: "1.0.0",
            language: "Pyrl",
            uptime: time(),
            users_registered: len(%users),
            active_sessions: len(%sessions)
        }
        return json_response(%response)
    
    # 404 Not Found
    $body = $error_page
    $body = replace($body, "{{CODE}}", "404")
    $body = replace($body, "{{MESSAGE}}", "Page Not Found")
    return html_response($body, 404)

# ============================================================
# Server Initialization
# ============================================================

print("")
print("=" * 60)
print("  Pyrl Web Server with Authentication")
print("=" * 60)
print("")
print("  Host: " + $HOST)
print("  Port: " + $PORT)
print("")
print("  Routes:")
print("    GET  /              - Login page")
print("    POST /login         - Process authentication")
print("    GET  /dashboard     - Admin dashboard (requires auth)")
print("    POST /logout        - Logout user")
print("    GET  /api/status    - API status endpoint")
print("")
print("  Test credentials:")
print("    admin / admin123    - Administrator")
print("    user  / user123     - Regular user")
print("    guest / guest123    - Guest user")
print("")
print("=" * 60)
print("")

# Export app for server wrapper - this is required for run_web_app.py
$app = {handle: &handle_request, port: int($PORT)}
