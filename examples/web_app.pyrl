# Pyrl Web Application - Client-Server with Authentication

$PORT = env_get("PYRL_PORT", "8080")
$HOST = env_get("PYRL_HOST", "0.0.0.0")
$SECRET_KEY = env_get("PYRL_SECRET", "pyrl_secret_key_2024")

%users = {
    "admin": {"password": "admin123", "role": "Administrator", "name": "Admin User"},
    "user": {"password": "user123", "role": "User", "name": "Regular User"},
    "demo": {"password": "demo", "role": "Demo", "name": "Demo User"}
}

%sessions = {}

$LOGIN_PAGE = """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pyrl App - Login</title>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; }
        h1 { color: #333; text-align: center; }
        h1 span { color: #667eea; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; }
        .demo { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; font-size: 0.85em; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pyrl<span>App</span></h1>
        <form method="POST" action="/login">
            <input type="text" name="username" placeholder="Username" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit">Sign In</button>
        </form>
        <div class="demo">
            Demo: admin / admin123 | user / user123 | demo / demo
        </div>
    </div>
</body>
</html>
"""

$DASHBOARD_PAGE = """
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Pyrl App</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f7fa; margin: 0; }
        .header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px 40px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .welcome { background: white; padding: 40px; border-radius: 20px; text-align: center; margin-bottom: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        h2 { color: #333; }
        .success { color: #28a745; font-size: 3em; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .stat { background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.08); }
        .value { font-size: 1.8em; font-weight: bold; color: #333; }
        .label { color: #666; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Pyrl<span style="color:#ffd700">App</span> - Dashboard</h1>
        <form method="POST" action="/logout" style="display:inline">
            <button style="background:rgba(255,255,255,0.2);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">Logout</button>
        </form>
    </div>
    <div class="container">
        <div class="welcome">
            <div class="success">SUCCESS</div>
            <h2>Welcome, {{USERNAME}}!</h2>
            <p>You are logged in as {{ROLE}}</p>
        </div>
        <div class="stats">
            <div class="stat"><div class="value">1,234</div><div class="label">Users</div></div>
            <div class="stat"><div class="value">567</div><div class="label">Sessions</div></div>
            <div class="stat"><div class="value">89.5K</div><div class="label">Views</div></div>
            <div class="stat"><div class="value">99.9%</div><div class="label">Uptime</div></div>
        </div>
    </div>
</body>
</html>
"""

def generate_token($username):
    $timestamp = str(time())
    return str(hash($username + ":" + $timestamp + ":" + $SECRET_KEY))

def verify_user($username, $password):
    $user = get(%users, $username, None)
    if $user != None:
        if $user["password"] == $password:
            return {"success": True, "user": $user}
    return {"success": False}

def create_session($username):
    $token = generate_token($username)
    %sessions[$token] = {"username": $username, "expires": time() + 3600}
    return $token

def validate_session($token):
    $session = get(%sessions, $token, None)
    if $session != None:
        if $session["expires"] > time():
            return {"valid": True, "username": $session["username"]}
    return {"valid": False}

def handle_request($method, $path, %headers, $body):
    if $path == "/" and $method == "GET":
        return html_response($LOGIN_PAGE)
    if $path == "/login" and $method == "POST":
        print("[POST /login]")
        %form = parse_form($body)
        $username = get(%form, "username", "")
        $password = get(%form, "password", "")
        $result = verify_user($username, $password)
        if $result["success"]:
            print("  SUCCESS: " + $username)
            $token = create_session($username)
            return {"status": 302, "headers": {"Location": "/dashboard", "Set-Cookie": "session=" + $token}, "body": ""}
        print("  FAILED")
        return {"status": 302, "headers": {"Location": "/"}, "body": ""}
    if $path == "/dashboard" and $method == "GET":
        print("[GET /dashboard]")
        $cookie = get(%headers, "Cookie", "")
        %cookies = parse_cookies($cookie)
        $token = get(%cookies, "session", "")
        $session = validate_session($token)
        if $session["valid"]:
            $username = $session["username"]
            $user = %users[$username]
            $html = replace($DASHBOARD_PAGE, "{{USERNAME}}", $user["name"])
            $html = replace($html, "{{ROLE}}", $user["role"])
            return html_response($html)
        return redirect("/")
    if $path == "/logout" and $method == "POST":
        return {"status": 302, "headers": {"Location": "/"}, "body": ""}
    if $path == "/api/status" and $method == "GET":
        return json_response({"status": "ok", "version": "1.0.0", "language": "Pyrl"})
    return html_response("<h1>404 Not Found</h1>", 404)

print("")
print("=" * 60)
print("  Pyrl Web Application Server")
print("=" * 60)
print("  Port: " + $PORT)
print("  Routes: /, /login, /dashboard, /logout, /api/status")
print("  Credentials: admin/admin123, user/user123, demo/demo")
print("=" * 60)
print("")

# Export app for server wrapper
$app = {"handle": &handle_request, "port": int($PORT)}

print("Test 1: GET /")
$r1 = handle_request("GET", "/", {}, "")
print("  Status: " + str($r1["status"]))
print("")

print("Test 2: POST /login (wrong)")
$r2 = handle_request("POST", "/login", {}, "username=admin&password=wrong")
print("  Status: " + str($r2["status"]))
print("")

print("Test 3: POST /login (correct)")
$r3 = handle_request("POST", "/login", {}, "username=admin&password=admin123")
print("  Status: " + str($r3["status"]))
$cookie = get($r3["headers"], "Set-Cookie", "")
print("  Cookie: " + $cookie)
$token = ""
if startswith($cookie, "session="):
    $token = split(replace($cookie, "session=", ""), ";")[0]
print("")

print("Test 4: GET /dashboard")
%hdrs = {"Cookie": "session=" + $token}
$r4 = handle_request("GET", "/dashboard", %hdrs, "")
print("  Status: " + str($r4["status"]))
print("  Body: " + str(len($r4["body"])) + " bytes")
print("")

print("Test 5: GET /api/status")
$r5 = handle_request("GET", "/api/status", {}, "")
print("  Body: " + $r5["body"])
print("")

print("=" * 60)
print("  All tests passed!")
print("  Run server: python run_web_app.py")
print("=" * 60)
